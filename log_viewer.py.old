#!/usr/bin/env python3
"""
Internet Monitor - Log Viewer Web UI

- Shows the connection log (tail of the configured log file)
- Allows clearing the log via a "Clear Log" button
- Optional IP allow-list based on [web].allowed_hosts in config.ini
"""

from __future__ import annotations

import os
import configparser
from typing import List, Optional

from flask import Flask, request, render_template, abort, redirect, url_for

# ---------------------------------------------------------------------------
# Config loading
# ---------------------------------------------------------------------------

CONFIG_ENV_VAR = "INTERNET_MONITOR_CONFIG"
DEFAULT_CONFIG_PATH = "/config/internet_monitor/config.ini"
CONFIG_PATH = os.environ.get(CONFIG_ENV_VAR, DEFAULT_CONFIG_PATH)

parser = configparser.ConfigParser()
parser.read(CONFIG_PATH)

if not parser.has_section("web"):
    raise RuntimeError(f"[web] section missing in config file: {CONFIG_PATH}")

WEB = parser["web"]

TITLE: str = WEB.get("title", "Internet Connection Monitor")
LOG_PATH: str = WEB.get("log_path", "/var/log/connection.log")
LOG_LINES: int = WEB.getint("log_lines", 100)
FLASK_PORT: int = WEB.getint("port", 5005)

_raw_hosts = WEB.get("allowed_hosts", "").replace(",", " ")
ALLOWED_HOSTS: List[str] = [h.strip() for h in _raw_hosts.split() if h.strip()]

LOG_PATH = os.path.abspath(LOG_PATH)


# ---------------------------------------------------------------------------
# Helpers
# ---------------------------------------------------------------------------

def load_log_text() -> str:
    """
    Load the last LOG_LINES lines from LOG_PATH.
    Pure Python tail, no external commands.
    """
    if not os.path.exists(LOG_PATH):
        return ""

    try:
        with open(LOG_PATH, "r", encoding="utf-8", errors="replace") as f:
            lines = f.read().splitlines()
    except OSError:
        return ""

    if not lines:
        return ""

    tail = lines[-LOG_LINES:]
    return "\n".join(tail)


# ---------------------------------------------------------------------------
# Flask app
# ---------------------------------------------------------------------------

app = Flask(__name__)


@app.before_request
def limit_remote_addr():
    """
    Optional IP restriction based on [web].allowed_hosts.
    If the list is empty, allow all.
    """
    if not ALLOWED_HOSTS:
        return

    remote = request.remote_addr
    if remote not in ALLOWED_HOSTS:
        abort(403, description="You're not allowed to access this resource")


@app.route("/health")
def health():
    return "ok", 200


@app.route("/")
def index():
    log_text = load_log_text()
    return render_template(
        "index.html",
        title=TITLE,
        log=log_text,
        log_lines=LOG_LINES,
        log_path=LOG_PATH,
    )


@app.route("/clear-log", methods=["POST"])
def clear_log():
    """
    Truncate the log file to zero bytes (create if missing),
    then redirect back to the main page.
    """
    try:
        os.makedirs(os.path.dirname(LOG_PATH), exist_ok=True)
        with open(LOG_PATH, "w", encoding="utf-8"):
            pass
    except OSError:
        # Ignore errors, user will just see the old log or nothing
        pass

    return redirect(url_for("index"))


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=FLASK_PORT, debug=True)
